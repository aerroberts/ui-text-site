var b=Object.defineProperty;var $=(r,t,e)=>t in r?b(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var o=(r,t,e)=>$(r,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}})();var c=(r=>(r.CURRENCY_GAIN="gain_currency",r.CURRENCY_SPEND="spend_currency",r.CURRENCY_MAX_REACHED="currency_max_reached",r.CURRENCY_MIN_REACHED="currency_min_reached",r.CURRENCY_INCREASE_MAX="increase_currency_max",r.CURRENCY_EMIT_VALUE="emit_currency_value",r.CHOICE_PROPOSE="propose_choice",r.CHOICE_SELECTED="choice_selected",r.GAME_START="game_start",r.SHOW_STORY_EVENT="show_story_event",r))(c||{});const R=new Date,M=()=>{const t=new Date().getTime()-R.getTime(),e=Math.floor(t/(1e3*60*60)),s=Math.floor(t%(1e3*60*60)/(1e3*60)),n=Math.floor(t%(1e3*60)/1e3);return`${e.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`},v={info:"color: #2196f3; font-weight: bold",warn:"color: #ff9800; font-weight: bold",error:"color: #f44336; font-weight: bold",default:"color: #9e9e9e"},f=(r,t,e)=>{const s=v[t]||v.default;console.log(`%c[${M()}] %c${r} %c${t}%c ${e}`,"color: #888","color: #fff; font-weight: bold",s,"color: #888")},m=r=>({info:(t,e)=>{const s=e?`${t} ${JSON.stringify(e)}`:t;f(r,"info",s)},warn:(t,e)=>{const s=e?`${t} ${JSON.stringify(e)}`:t;f(r,"warn",s)},error:(t,e)=>{const s=e?`${t} ${JSON.stringify(e)}`:t;f(r,"error",s)},debug:(t,e)=>{const s=e?`${t} ${JSON.stringify(e)}`:t;f(r,"debug",s)},child:t=>m(`${r}:${t}`)});class p{constructor(t){o(this,"name","base");o(this,"log");o(this,"baseElement");o(this,"game");o(this,"events");o(this,"save");this.name=t,this.log=m(t);const e=document.getElementById("app");this.baseElement=document.createElement("div"),this.baseElement.className="controller",e.appendChild(this.baseElement)}register(t){this.game=t,this.events=t.events,this.save=t.save,this.log.info(`${this.name} controller initializing`),this.initialize()}}class N extends p{constructor(){super("choice");o(this,"choices",[]);o(this,"currentChoice",null);o(this,"choiceDisplay",null);o(this,"currencyOptions",[]);o(this,"choiseDisabled",!1)}initialize(){this.events.on(c.CHOICE_PROPOSE,this.onChoiceProposed.bind(this)),this.events.on(c.CURRENCY_EMIT_VALUE,this.onCurrencyValueEmitted.bind(this))}createChoiceDisplayElement(e){var E,_;const s=document.createElement("div");s.className="choice-display",s.innerHTML=`
            <div class="choice-content">
                <div class="choice-header">
                    <span class="choice-description">${e.description}</span>
                </div>
                <div class="choice-options" style="opacity: 0;">
                ${e.options.map(a=>`
                    <button class="choice-option" data-option-id="${a.id}">
                        <div class="option-text">${a.text}</div>
                        ${a.cost?`
                            <div class="option-cost" style="background-color: ${a.cost.currency.color};">
                                ${a.cost.amount} ${a.cost.currency.symbol}
                            </div>
                        `:""}
                    </button>
                `).join("")}
                </div>
            </div>
        `,this.choiceDisplay=s,this.baseElement.appendChild(s);const n=s.querySelector(".choice-description"),i=s.querySelector(".choice-options"),l=i.querySelectorAll(".choice-option");let h="";const S=setInterval(()=>{h+=e.description[h.length],n&&(n.textContent=h),h.length>=e.description.length&&(clearInterval(S),i.style.opacity="1")},30);for(const a of l){const u=e.options.find(y=>y.id===a.dataset.optionId);if(u&&u.disableFlags)for(const y of u.disableFlags)this.save.getFlag(y)&&(a.setAttribute("disabled",""),a.style.opacity="0.5",a.style.cursor="not-allowed")}for(const a of l){const u=e.options.find(y=>y.id===a.dataset.optionId);u&&(this.currencyOptions.push({element:a,currency:((E=u.cost)==null?void 0:E.currency.name)||"",requiredAmount:((_=u.cost)==null?void 0:_.amount)||0}),a.addEventListener("click",()=>{this.choiseDisabled||(this.choiseDisabled=!0,s.style.opacity="0",u.cost&&this.events.emit(c.CURRENCY_SPEND,{currency:u.cost.currency.name,amount:u.cost.amount}),setTimeout(()=>{this.events.emit(c.CHOICE_SELECTED,{choiceId:e.id,optionId:u.id,option:e}),this.destroyChoiceDisplayElement(),this.attemptProgressChoice()},1e3))}))}}destroyChoiceDisplayElement(){this.choiceDisplay&&(this.choiceDisplay.remove(),this.choiceDisplay=null,this.currentChoice=null),this.attemptProgressChoice()}attemptProgressChoice(){if(this.choices.length===0){this.log.info("No choices to progress");return}if(this.currentChoice){this.log.info("Already have a current choice");return}if(this.currentChoice=this.choices.shift()||null,!this.currentChoice){this.log.error("No current choice to progress");return}this.choiseDisabled=!1,this.createChoiceDisplayElement(this.currentChoice)}onCurrencyValueEmitted(e){this.currencyOptions.forEach(s=>{s.currency===e.currency.name&&(e.value>=s.requiredAmount?(s.element.style.opacity="1",s.element.removeAttribute("disabled"),s.element.style.cursor="pointer"):(s.element.style.opacity="0.5",s.element.setAttribute("disabled",""),s.element.style.cursor="not-allowed"))})}onChoiceProposed(e){this.choices.push(e.choice),this.attemptProgressChoice()}}class V extends p{constructor(){super("currency");o(this,"currencies",new Map)}initialize(){this.log.info("CurrencyController initialized"),this.events.on(c.CURRENCY_GAIN,this.onCurrencyGained.bind(this)),this.events.on(c.CURRENCY_SPEND,this.onCurrencySpent.bind(this)),this.events.on(c.CURRENCY_INCREASE_MAX,this.onCurrencyMaxIncreased.bind(this)),setInterval(()=>this.emitCurrencyValue(),1e3)}isCurrencyKnown(e){return!!this.currencies.get(e)}getCurrency(e){const s=this.currencies.get(e);if(!s)throw new Error(`Currency ${e} not found`);return s}updateCurrencyValue(e,s){const n=this.getCurrency(e),i=n.currentValue,l=Math.max(0,Math.min(s,n.maxValue)),h=l/n.maxValue*100;n.currentValue=l,n.valueTextDisplay.textContent=l.toString(),n.valueBarDisplay.style.width=`${h}%`,this.checkForMinMaxEvents(n,i,l)}updateCurrencyMax(e,s){const n=this.getCurrency(e);if(n.maxValue=Math.max(s,0),n.currentValue>n.maxValue)this.updateCurrencyValue(e,n.maxValue);else{const i=n.currentValue/n.maxValue*100;n.valueBarDisplay.style.width=`${i}%`}}checkForMinMaxEvents(e,s,n){n>=e.maxValue&&s<e.maxValue&&this.events.emit(c.CURRENCY_MAX_REACHED,{currency:e.currency.name,value:n,maxValue:e.maxValue}),n<=0&&s>0&&this.events.emit(c.CURRENCY_MIN_REACHED,{currency:e.currency.name,value:n})}emitCurrencyValue(){for(const e of this.currencies.values())this.events.emit(c.CURRENCY_EMIT_VALUE,{currency:e.currency,value:e.currentValue})}createCurrencyDisplayElement(e){const s=document.createElement("div");s.innerHTML=`
            <div class="currency-container">
                <div class="currency-display">
                    <div class="currency-value-bar" style="background-color: ${e.color}; width: 0%;"></div>
                </div>
                <div class="currency-symbol">${e.symbol}</div>
                <div class="currency-value">0</div>
            </div>
        `;const n=s.querySelector(".currency-container"),i=s.querySelector(".currency-value"),l=s.querySelector(".currency-value-bar");return this.baseElement.appendChild(s),{currency:e,currentValue:0,maxValue:e.initialMaxValue,container:n,valueTextDisplay:i,valueBarDisplay:l}}onCurrencyGained(e){if(!this.isCurrencyKnown(e.currency.name)){const n=this.createCurrencyDisplayElement(e.currency);this.currencies.set(e.currency.name,n)}const s=this.getCurrency(e.currency.name).currentValue;this.updateCurrencyValue(e.currency.name,s+e.amount),this.log.info(`Gained ${e.amount} ${e.currency.name}`)}onCurrencySpent(e){if(!this.isCurrencyKnown(e.currency)){this.log.warn(`Cannot spend ${e.currency}: currency not found`);return}const s=this.getCurrency(e.currency);if(s.currentValue<e.amount){this.log.warn(`Cannot spend ${e.amount} ${e.currency}: insufficient funds (have ${s.currentValue})`);return}this.updateCurrencyValue(e.currency,s.currentValue-e.amount),this.log.info(`Spent ${e.amount} ${e.currency}`)}onCurrencyMaxIncreased(e){if(!this.isCurrencyKnown(e.currency.name)){const n=this.createCurrencyDisplayElement(e.currency);this.currencies.set(e.currency.name,n)}const s=this.getCurrency(e.currency.name);this.updateCurrencyMax(e.currency.name,s.maxValue+e.amount),this.log.info(`Increased ${e.currency.name} max by ${e.amount} to ${s.maxValue}`)}}class w extends p{constructor(){super("machine");o(this,"machineParts",new Map)}registerMachinePart(e){this.machineParts.set(e.id,e);const s=document.createElement("div");s.className="machine-part-container",s.appendChild(e.element),this.baseElement.appendChild(s)}initialize(){this.log.info("MachineController initialized - Cyberpunk Machine Assembly")}}const x={heat:{name:"heat",symbol:"à¦Œ",color:"#FF0000",initialMaxValue:100}},g={id:"initial_boot",description:"Cold. You feel cold. You are loosing power slowly to the environment.",options:[{id:"query_systems",text:"query your systems for any information",disableFlags:["initial_boot_query_systems"]},{id:"scan_area",text:"use your sensors to scan the area"}]},D={id:"scan_your_system",description:"You scan your system for any information, and find nothing.",options:[{id:"_",text:"Ok"}]};class O extends p{constructor(){super("story")}initialize(){this.log.info("MachineController initialized - Cyberpunk Machine Assembly"),this.events.on(c.SHOW_STORY_EVENT,this.onStoryEvent.bind(this)),this.events.on(c.CHOICE_SELECTED,this.onStoryChoiceSelected.bind(this)),setTimeout(()=>{this.events.emit(c.SHOW_STORY_EVENT,{event:"story_crash_landing"})},1e3)}choice(t){this.events.emit(c.CHOICE_PROPOSE,{choice:t})}onStoryEvent(t){t.event==="story_crash_landing"&&this.choice(g)}onStoryChoiceSelected(t){t.choiceId==="initial_boot"&&(t.optionId==="query_systems"?(this.save.setFlag("initial_boot_query_systems"),this.choice(D),this.choice(g)):t.optionId==="scan_area"&&(this.events.emit(c.CURRENCY_GAIN,{currency:x.heat,amount:10}),this.choice(g)))}}class I{constructor(){o(this,"log",m("events"));o(this,"listeners",new Map)}on(t,e){const s=this.listeners.get(t)||[];s.push(e),this.listeners.set(t,s)}emit(t,e){this.log.info(`Emitting event: ${t}`);const s={type:t,...e},n=this.listeners.get(t)||[];for(const i of n)i(s)}}const C=m("save");class A{computeKey(t){return`savestate:${t}`}purge(){localStorage.clear()}save(t,e){C.info(`Saving ${t} to ${this.computeKey(t)}`),localStorage.setItem(this.computeKey(t),JSON.stringify(e))}setFlag(t){C.info(`Setting flag ${t}`);const e=this.load("flags")||[];e.push(t),this.save("flags",e)}getFlag(t){return C.info(`Getting flag ${t}`),(this.load("flags")||[]).includes(t)}removeFlag(t){C.info(`Removing flag ${t}`);const e=this.load("flags")||[];this.save("flags",e.filter(s=>s!==t))}load(t){const e=localStorage.getItem(this.computeKey(t));return e?JSON.parse(e):void 0}}class T{constructor(){o(this,"log");o(this,"save");o(this,"events");o(this,"controllers",new Map);this.log=m("game"),this.log.info("Game controller initialized"),this.events=new I,this.save=new A}addController(t){t.register(this),this.controllers.set(t.name,t)}start(){this.events.emit(c.GAME_START,{})}}const d=new T;d.save.purge();d.addController(new V);d.addController(new N);d.addController(new w);d.addController(new O);d.start();
